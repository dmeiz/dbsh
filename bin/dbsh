#! /usr/bin/env ruby

require 'readline'
require 'sequel'
require 'terminal-table'
require 'yaml'

#DB = Sequel.oracle 'cink', :user => 'dhensgen', :password => '...'
#puts DB.fetch('select count(1) from prod_sched').first

config = YAML.load(File.read("#{ENV['HOME']}/.dbsh"))[ARGV[0]]
DB = Sequel.connect(config)

File.open("#{ENV['HOME']}/.dbsh_history", 'r') do |f|
  f.each_line do |line|
    Readline::HISTORY << line
  end
end

#Example ~/.dbsh:
#dbsh_test:
#  adapter: sqlite
#  database: test.sqlite3
# 
## :adapter=>'postgres', :host=>'localhost', :database=>'blog', :user=>'user', :password=>'password'

def statement_type(statement)
  case statement
    when /\s*select/i then :select
    when /\s*insert/i then :insert
    when /\s*update/i then :update
    when /\s*delete/i then :delete
    when /\s*\\/i then :command
    else nil
  end
end

File.open("#{ENV['HOME']}/.dbsh_history", 'a') do |history|
  while line = Readline.readline('> ', true)
    history.write(line + "\n"); history.flush
    begin
      case statement_type(line)
      when :select
          dataset = DB[line]
          table = Terminal::Table.new(:headings => dataset.columns) do |t|
            dataset.each do |row|
              t.add_row(dataset.columns.map {|col| row[col]})
            end
          end
        puts table
      when :insert
        DB[line].insert
        puts 'Inserted row'
      when :update
        puts "Updated #{DB[line].update} rows"
      when :delete
        puts "Deleted #{DB[line].delete} rows"
      when :command
        case line
          when /\\q/ then exit(0)
          else puts 'Unknown command'
        end
      else
        puts 'Unknown statement type'
      end
    rescue Sequel::DatabaseError => e
      puts 'Error: ' + e.message
    end
  end
end

__END__

OVERVIEW

  A clone of mysql cli with these enhancements:

X   * Connect to multiple database types
    * Named connections
    * Improved editor-execute loop
    * Implemented in Ruby

  Beyond MVP:

    * Color output
    * Parameterized sql scripts
    * Column filtering

MVP

X  Connect to databases by name:
X
X    $ dbsh rockwell_dev
X    ~/.dbsh:
X      rockwell_dev:
X        adapter: mysql
X        username: root
X        password:
X        database: rockwell_dev

X  Connect to different types of databases:
X
X    * mysql
X    * oracle
X    * sqlite
X    * postgres

X  Execute sql:
X
X    > select * from illustrations;
X    id  name     updated_at
X    --  -------  ----------
X    10  Filmore  2012-06-12
X
X    > delete from illustrations;
X    Deleted 1 row.

X  Quit:
X
X    > \q
X    $

X  Report errors:
X
X    > foo;
X    ERROR: What is foo?

X  Install:
X
X    $ gem install dbsh

X  Readline support:
X
X    * History
X    * Edit line

  Execute a sql script:

    > \. illustrations.sql
    ...

  Execute a sql script from the command line:

    $ dbsh rockwell_dev < illustrations.sql
    ...

  Explore the database:

    > show tables;
    name
    -------------
    illustrations
    builds

    > desc illustrations;
    name       type
    ---------- ------------ 
    id         integer
    name       varchar(256)
    updated_at datetime

  Edit and run a sql script:

    > \e illustrations.sql
    (open script in $EDITOR, execute script if changes were made)
